= render_navigation(renderer: :bootstrap, level: 2, skip_if_empty: true, nav_class: 'nav-tabs')

= user_new_feature('results_event_data') do
  h5 Getting Started: Event Data Report
  a.close.btn-dismiss-alert href="#" title="Dismiss"
  a.video-thumbnail href="#" title="Play Video" data-video="//www.youtube.com/embed/EZr3hcqx6zI?rel=0" data-width="640" data-height="360"
    img src="/assets/video_arrow.png" /
  .feature-description
    p
      'The Event Data Report holds all of your post event data. Use this report to keep track of your executed events, review campaign performance, and export raw data to excel. Click on the video to the left for a quick overview or check out our
      a> href="http://support.brandscopic.com" target="_blank" support site
      | for more in depth info.

.sidebar#resource-filter-column
  #collection-list-filters
  #save-filters-btn.a.btn.btn-primary Save

#main.main.with-details-close-bar
  = resource_details_bar("You are viewing the Event Data report. Click to close.")
  .tab-content
    #list-view.tab-pane.active
      #list-tools.row-fluid
        .pull-right
          button.btn.download.xlsx-download-link data-url="#{url_for(format: :xls)}" title="Download" data-disable-with="..."
          a.btn.fullscreen.fullscreen-link href="#" data-fullscreen-element='main' title="Fullscreen"
      .collection-list-horizontal-scroll
        #columns-scoller-arrows.hide
          .left-arrow
            a.icon-angle-left
          .right-arrow
            a.icon-angle-right
        #event-data-totals
      .link-list
        ul#event-data-list
          li.placeholder
            p Select any filter to see results

= render partial: 'help_tutorial'

javascript:
  $('#collection-list-filters').filteredList({
    'source': '#{items_path(controller: 'results/event_data')}',
    'filtersUrl': '#{filters_path(controller: :events, with_event_data_only: true)}',
    'listContainer': '#event-data-list',
    'sorting': 'start_at',
    'sorting_dir': 'asc',
    'autoLoad': true,
    'includeCalendars': true,
    'selectDefaultDate': false,
    'includeAutoComplete': true,
    'autoCompletePath': '#{autocomplete_events_path(format: :json)}',
    'defaultParams': [{name: 'status[]', value: 'Active'}],
    'onChange': function(filterBox){
      $(document).trigger('event-data-filter:changed')
    },
    'onItemsLoad': function(response, page){
      if (response.find('div[data-content="totals-results"]').length > 0){
        $('#columns-scoller-arrows').removeClass('hide')
        $('#event-data-totals').html(response.find('div[data-content="totals-results"]').html())
      }
    },
    'onItemsChange': function(response, page){
      if ($('#event-data-list li').length > 0) {
        $('#list-tools').show()
      } else {
        $('#list-tools').hide()
        $('#event-data-list').append("<li class='placeholder'><p>No results. Select other filters to see results</p></li>");
      }
    }
  });



  $('#columns-scoller-arrows .right-arrow').on('click', function(){
    var $lastItem = $('.results-box-container>span:last-child:first');
    if (($lastItem.offset().left + $lastItem.width()) > $(this).offset().left ) {
      scroll = $('#list-view').data('scroll');
      if (typeof scroll == 'undefined'){
        scroll = 1;
      }
      $('#list-view').addClass('scroll-'+scroll).data('scroll', scroll + 1);
    }
    if (($lastItem.offset().left + $lastItem.width()) <= $(this).offset().left + ($lastItem.width()*2) ) {
      $('#list-view').addClass('scroll-last');
    }
  });

  $('#columns-scoller-arrows .left-arrow').on('click', function(){
    scroll = $('#list-view').data('scroll');
    $('#list-view').removeClass('scroll-last')
    if (scroll && scroll > 0){
      scroll = scroll-1;
      $('#list-view').removeClass('scroll-'+scroll).data('scroll', Math.max(scroll,1));
    }
  });

  $(window).bind('resize',function(){
    var $lastItem = $('.results-box-container>span:last-child:first');
    if ($lastItem.length > 0){
      if (($lastItem.offset().left + $lastItem.width()) <= $('#columns-scoller-arrows .right-arrow').offset().left ) {
         $('#list-view').addClass('scroll-last');
      } else {
        $('#list-view').removeClass('scroll-last');
      }
    }
  })
