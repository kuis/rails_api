#calendar-canvas

javascript:
  window.status='loading';
  var visitsCalendar, buildCalendar = function() {
    return $('#calendar-canvas').fullCalendar({
      header: {
        left: 'title',
        center: '',
        right: 'prev,next'
      },
      height: 'auto',
      titleFormat: {
        month: 'MMMM, YYYY'
      },
      defaultDate: "#{(params[:start_date] && params[:end_date] ? Timeliness.parse(params[:start_date]) + 15.days : Date.today).to_s(:full_calendar) }",
      buttonIcons: {
          prev: 'bc icon icon-angle-left',
          next: 'bc icon icon-angle-right',
          prevYear: 'bc icon icon-angle-left',
          nextYear: 'bc icon icon-angle-right'
      },
      fixedWeekCount: false,
      eventLimit: false,
      events: {
        events: function(start, end, timezone, callback){
          var data = '#{j params.to_query.html_safe}';
          if ($('#collection-list-filters').length > 0) {
            data = $('#collection-list-filters').filteredList('selectCalendarDates', start.toDate(), end.toDate()).filteredList('paramsQueryString');
          } else {
            data += "&start="+start+"&end="+end;
          }
          $.ajax({
              url: '#{brand_ambassadors_visits_url(format: :json)}',
              dataType: 'json',
              data: data,
              success: function(events) {
                  callback(events);
                  window.status = 'completed';
              }
          });
        },
        className: 'visit-item',
        backgroundColor: '#3e9ccf',
        borderColor: '#3e9ccf',
        textColor: 'white'
      },
      timeFormat: {
        'default': function(){ return ''; }
      },
      eventRender: function(visit, element) {
        var title = [(visit.visit_type_name || null), (visit.campaign_name || null)].filter(function(e) { return e; }).join(' - ');
        element.find('.fc-title').html(
          title + "<br/>" +
          "<span class='user-name'>" + visit.company_user.full_name + "</span>" +
          (visit.city ? " - <span class='city-name'>" + visit.city + "</span>" : '')
        );
      }
    });
  };

  if ($('#toggle-visits-view a').length == 0) {
    buildCalendar();
  } else {
    $('#toggle-visits-view a').click(function(e){
      if (e.currentTarget.getAttribute('href') === '#calendar-view' && document.location.pathname.indexOf('/calendar') < 0){
        history.pushState('data', '', document.location.protocol + '//' + document.location.host + document.location.pathname.replace('/calendar', '') + '/calendar');
      } else if (e.currentTarget.getAttribute('href') !== '#calendar-view' && document.location.pathname.indexOf('/calendar') >= 0) {
        history.pushState('data', '', document.location.protocol + '//' + document.location.host + document.location.pathname.replace('/calendar', ''));
      }
    });
    $('#toggle-visits-view a').on('shown', function(e){
      $('#toggle-visits-view a').removeClass('active');
      $(e.target).addClass('active');
      if (e.target.getAttribute('href') == '#calendar-view'){
        $('#pdf-export').data('url', '#{brand_ambassadors_visits_path(mode: :calendar, format: :pdf)}');
        $('.dates-range-filter').slideUp();
        $('.dates-pref').slideUp();
        if (typeof visitsCalendar == 'undefined') {
          visitsCalendar = buildCalendar();
        } else {
          visitsCalendar.fullCalendar('refetchEvents');
        }
      } else {
        $('#pdf-export').data('url', '#{brand_ambassadors_visits_path(format: :pdf)}');
        $('.dates-range-filter').slideDown();
        $('.dates-pref').slideDown();
      }
    });
  }

  $(window).on('popstate', function(){
    if (document.location.pathname.indexOf('/calendar') >= 0 && !$('#toggle-visits-view a.calendar').hasClass('active')) {
      $('#toggle-visits-view a.calendar').tab('show');
    } else if (document.location.pathname.indexOf('/calendar') < 0 && !$('#toggle-visits-view a.list').hasClass('active')) {
      $('#toggle-visits-view a.list').tab('show');
    }
  });
