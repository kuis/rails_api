$.widget 'nmk.filterBox', {
	options: {
		onChange: false,
		includeCalendars: false,
		includeSearchBox: true
	},
	_create: () ->
		@element.addClass('filter-box')
		@form = $('<form action="#" method="get">').appendTo(@element).submit (e)->
			e.preventDefault()
			e.stopPropagation()
			false
		@form.data('serializedData', null)

		if @options.includeSearchBox
			@_addSearchBox()

		if @options.includeCalendars
			@_addCalendars()


	getFilters: () ->
		@form.serializeArray()

	describeFilters: () ->
		description = @_describeDateRange()
		description += @_describeSearch()

	_addSearchBox: () ->
		previousValue = '';
		@searchInput = $('<input type="text" name="with_text" class="search-query" placeholder="Search" id="search-box-filter">').appendTo @form
		@searchInput.keyup =>
			if previousValue isnt @searchInput.val()
				previousValue = @searchInput.val()
				@_filtersChanged()

	_addCalendars: () ->
		@startDateInput = $('<input type="hidden" name="by_period[start_date]">').appendTo @form
		@endDateInput = $('<input type="hidden" name="by_period[end_date]">').appendTo @form
		container = $('<div class="dates-range-filter">').appendTo @element
		container.datepick {
			rangeSelect: true,
			monthsToShow: 2,
			changeMonth: false,
			defaultDate: '05/20/2013',
			onSelect: (dates) =>
				start_date = @_formatDate(dates[0])
				@startDateInput.val start_date

				@endDateInput.val ''
				if dates[0].toLocaleString() != dates[1].toLocaleString()
					end_date = @_formatDate(dates[1])
					@endDateInput.val end_date

				@_filtersChanged()
		}

	_describeDateRange: () ->
		description = ''
		startDate = @startDateInput.val()
		endDate = @endDateInput.val()
		if startDate
			currentDate = new Date()
			today = new Date(currentDate.getFullYear(), currentDate.getMonth() , currentDate.getDate(), 0, 0, 0);
			yesterday = new Date(today.getFullYear(), today.getMonth() , today.getDate()-1, 0, 0, 0);
			tomorrow = new Date(today.getFullYear(), today.getMonth() , today.getDate()+1, 0, 0, 0);
			startDateLabel = if startDate == @_formatDate(today) then 'today' else if startDate == @_formatDate(yesterday) then 'yesterday' else if startDate == @_formatDate(tomorrow) then 'tomorrow' else startDate
			endDateLabel = if endDate == @_formatDate(today) then 'today' else if endDate == @_formatDate(yesterday) then 'yesterday' else if endDate == @_formatDate(tomorrow) then 'tomorrow' else endDate

			if startDate and endDate and (startDate != endDate)
				if @_parseDate(endDate) < today
					description = "took place between #{startDateLabel} and #{endDateLabel}"
				else
					description = "taking place between #{startDateLabel} and #{endDateLabel}"
			else if startDate
				if startDate == startDateLabel
					startDateLabel = "at #{startDateLabel}"
				if startDate == @_formatDate(today)
					description = "taking place today"
				else if @_parseDate(startDate) > today
					description = "taking place #{startDateLabel}"
				else
					description = "took place #{startDateLabel}"

		description

	_describeSearch: () ->
		description = ''
		if @searchInput.val()
			description = " matching \"#{@searchInput.val()}\""
		description

	_formatDate: (date) ->
		"#{date.getMonth() + 1}/#{date.getDate()}/#{date.getFullYear()}"

	_parseDate: (date) ->
		parts = date.split('/')
		new Date(parts[2], parseInt(parts[0])-1, parts[1],0,0,0)

	_filtersChanged: () ->
		if @options.onChange and @form.data('serializedData') != @form.serialize()
			@form.data('serializedData', @form.serialize())
			@options.onChange(@)
}
